# 课时1 设计文档 - 项目架构与核心接口

## 文档目的
定义项目的整体架构、核心类型和接口规范，为代码生成提供结构化指导。

## 项目结构定义

```
snake-game/
├── project.godot
├── scenes/
│   ├── Main.tscn
│   ├── Menu.tscn
│   ├── Game.tscn
│   └── GameOver.tscn
├── scripts/
│   ├── managers/
│   │   ├── GameManager.gd
│   │   ├── SceneManager.gd
│   │   └── SaveManager.gd
│   ├── game/
│   │   ├── Snake.gd
│   │   ├── Food.gd
│   │   └── Grid.gd
│   ├── ui/
│   │   ├── MainMenu.gd
│   │   └── GameUI.gd
│   └── utils/
│       ├── Constants.gd
│       ├── GameColors.gd
│       └── GameSizes.gd
└── assets/
    ├── fonts/
    └── sounds/
```

## 核心常量定义

### Constants.gd
```gdscript
class_name Constants
extends Resource

# 网格配置
const GRID_SIZE: int = 20
const GRID_WIDTH: int = 40
const GRID_HEIGHT: int = 30

# 游戏配置
const BASE_MOVE_SPEED: float = 5.0
const MAX_MOVE_SPEED: float = 15.0
const FOOD_SCORE: int = 10

# 文件路径
const SAVE_FILE_PATH: String = "user://save_game.dat"
```

### GameColors.gd
```gdscript
class_name GameColors
extends Resource

const PRIMARY_GREEN: Color = Color(0.153, 0.682, 0.376)
const ACCENT_RED: Color = Color(0.906, 0.298, 0.235)
const BACKGROUND_DARK: Color = Color(0.173, 0.243, 0.314)
const WHITE: Color = Color(1.0, 1.0, 1.0)

const SNAKE_HEAD_COLOR: Color = PRIMARY_GREEN
const SNAKE_BODY_COLOR: Color = PRIMARY_GREEN
const FOOD_COLOR: Color = ACCENT_RED
```

### GameSizes.gd
```gdscript
class_name GameSizes
extends Resource

const SNAKE_SEGMENT_SIZE: int = 18
const FOOD_SIZE: int = 16
const BUTTON_HEIGHT: int = 40
const FONT_SIZE_TITLE: int = 32
const FONT_SIZE_MEDIUM: int = 18
```

## 核心管理器接口

### SceneManager.gd
```gdscript
class_name SceneManager
extends Node

signal scene_changed(scene_name: String)

enum SceneType { MENU, GAME, SETTINGS, GAME_OVER }

const SCENE_PATHS: Dictionary = {
    SceneType.MENU: "res://scenes/Menu.tscn",
    SceneType.GAME: "res://scenes/Game.tscn",
    SceneType.SETTINGS: "res://scenes/Settings.tscn",
    SceneType.GAME_OVER: "res://scenes/GameOver.tscn"
}

func change_scene(scene_type: SceneType) -> void
func get_current_scene() -> Node
```

### GameManager.gd
```gdscript
class_name GameManager
extends Control

signal game_started
signal game_over(final_score: int)
signal score_changed(new_score: int)

enum GameState { MENU, PLAYING, PAUSED, GAME_OVER }

var current_state: GameState = GameState.MENU
var score: int = 0
var level: int = 1
var game_speed: float = Constants.BASE_MOVE_SPEED

var snake: Snake
var food: Food
var grid: Grid

func start_game() -> void
func pause_game() -> void
func end_game() -> void
func update_score(points: int) -> void
```

### SaveManager.gd
```gdscript
class_name SaveManager
extends Node

class SaveData:
    var high_score: int = 0
    var games_played: int = 0
    var settings: Dictionary = {}
    
    func to_dict() -> Dictionary
    func from_dict(data: Dictionary) -> void

func save_game_data(data: SaveData) -> bool
func load_game_data() -> SaveData
func has_save_file() -> bool
```

## 场景结构规范

### Main.tscn
```
Main (Node)
├── SceneManager (Node)
├── SaveManager (Node)
└── CurrentScene (Node)
```

### Menu.tscn
```
Menu (Control) [MainMenu.gd]
├── Background (ColorRect)
└── CenterContainer (CenterContainer)
    └── VBoxContainer (VBoxContainer)
        ├── Title (Label)
        └── ButtonContainer (VBoxContainer)
            ├── StartButton (Button)
            ├── SettingsButton (Button)
            └── QuitButton (Button)
```

### Game.tscn
```
Game (Control) [GameManager.gd]
├── Background (ColorRect)
├── GameArea (Control)
│   ├── Grid (Node2D) [Grid.gd]
│   ├── Snake (Node2D) [Snake.gd]
│   └── Food (Node2D) [Food.gd]
└── UI (CanvasLayer)
    └── GameUI (Control) [GameUI.gd]
        ├── ScoreLabel (Label)
        └── PauseButton (Button)
```

## 输入系统规范

### 输入映射
```
move_up: W, Up Arrow
move_down: S, Down Arrow
move_left: A, Left Arrow
move_right: D, Right Arrow
pause: Space, P
confirm: Enter
cancel: Escape
```

### 输入处理接口
```gdscript
func _input(event: InputEvent) -> void:
    match current_state:
        GameState.PLAYING:
            handle_game_input(event)
        GameState.PAUSED:
            handle_pause_input(event)

func handle_game_input(event: InputEvent) -> void
func handle_pause_input(event: InputEvent) -> void
```

## 信号系统架构

### 核心信号连接
```gdscript
# GameManager中的信号连接
func _ready() -> void:
    snake.food_eaten.connect(_on_snake_food_eaten)
    snake.wall_hit.connect(_on_snake_wall_hit)
    snake.self_hit.connect(_on_snake_self_hit)
    food.food_spawned.connect(_on_food_spawned)
```

## 错误处理框架

### 错误类型定义
```gdscript
enum ErrorType {
    NONE,
    FILE_NOT_FOUND,
    INVALID_DATA,
    NETWORK_ERROR
}

class GameError:
    var type: ErrorType
    var message: String
    
    func _init(error_type: ErrorType, error_message: String)
```

## 性能优化架构

### 对象池接口
```gdscript
class ObjectPool:
    var _pool: Array = []
    var _create_func: Callable
    var _reset_func: Callable
    
    func get_object()
    func return_object(obj) -> void
```

### 渲染层次
```
CanvasLayer -1: 静态背景
CanvasLayer 0:  游戏元素
CanvasLayer 1:  UI界面
CanvasLayer 2:  特效
```

## 代码生成要求

### 必须实现
- [ ] 完整项目结构
- [ ] 所有常量定义
- [ ] 核心管理器类
- [ ] 场景结构搭建
- [ ] 信号系统连接

### 质量标准
- [ ] 统一命名规范
- [ ] 明确类型声明
- [ ] 完整错误处理
- [ ] 性能优化考虑