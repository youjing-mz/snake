# 课时4 设计文档 - 多人游戏服务器架构

## 文档目的
定义多人游戏服务器的架构、通信协议和核心接口规范。

## 服务器架构

### 项目结构
```
server/
├── main.go
├── config/
│   ├── config.go
│   └── database.go
├── handlers/
│   ├── websocket.go
│   └── api.go
├── models/
│   ├── player.go
│   ├── room.go
│   ├── game_record.go
│   └── message.go
├── services/
│   ├── room_service.go
│   ├── player_service.go
│   └── game_service.go
├── database/
│   ├── migrations/
│   └── queries/
└── utils/
    ├── logger.go
    └── validator.go
```

## 数据库设计

### 数据库架构
```sql
-- 玩家表
CREATE TABLE players (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE,
    password_hash VARCHAR(255),
    total_games INT DEFAULT 0,
    total_score BIGINT DEFAULT 0,
    best_score INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 游戏记录表
CREATE TABLE game_records (
    id VARCHAR(36) PRIMARY KEY,
    room_id VARCHAR(36) NOT NULL,
    player_id VARCHAR(36) NOT NULL,
    score INT NOT NULL,
    snake_length INT NOT NULL,
    survival_time INT NOT NULL, -- 秒
    game_duration INT NOT NULL, -- 秒
    is_winner BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (player_id) REFERENCES players(id)
);

-- 房间历史表
CREATE TABLE room_history (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    max_players INT NOT NULL,
    actual_players INT NOT NULL,
    winner_id VARCHAR(36),
    game_duration INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    finished_at TIMESTAMP,
    FOREIGN KEY (winner_id) REFERENCES players(id)
);

-- 索引
CREATE INDEX idx_players_email ON players(email);
CREATE INDEX idx_game_records_player ON game_records(player_id);
CREATE INDEX idx_game_records_room ON game_records(room_id);
CREATE INDEX idx_room_history_winner ON room_history(winner_id);
```

### 数据模型接口
```go
type GameRecord struct {
    ID           string    `json:"id" db:"id"`
    RoomID       string    `json:"room_id" db:"room_id"`
    PlayerID     string    `json:"player_id" db:"player_id"`
    Score        int       `json:"score" db:"score"`
    SnakeLength  int       `json:"snake_length" db:"snake_length"`
    SurvivalTime int       `json:"survival_time" db:"survival_time"`
    GameDuration int       `json:"game_duration" db:"game_duration"`
    IsWinner     bool      `json:"is_winner" db:"is_winner"`
    CreatedAt    time.Time `json:"created_at" db:"created_at"`
}

type PlayerStats struct {
    ID         string `json:"id" db:"id"`
    Name       string `json:"name" db:"name"`
    TotalGames int    `json:"total_games" db:"total_games"`
    TotalScore int64  `json:"total_score" db:"total_score"`
    BestScore  int    `json:"best_score" db:"best_score"`
}
```

## 通信协议设计

### 消息类型定义
```go
const (
    // 连接管理
    MsgTypeJoin        = "join"
    MsgTypeLeave       = "leave"
    MsgTypePing        = "ping"
    MsgTypePong        = "pong"
    
    // 房间操作
    MsgTypeCreateRoom  = "create_room"
    MsgTypeJoinRoom    = "join_room"
    MsgTypeLeaveRoom   = "leave_room"
    MsgTypeRoomList    = "room_list"
    MsgTypeRoomUpdate  = "room_update"
    
    // 游戏控制
    MsgTypeStartGame   = "start_game"
    MsgTypePlayerInput = "player_input"
    MsgTypePauseGame   = "pause_game"
    MsgTypeResumeGame  = "resume_game"
    
    // 状态同步
    MsgTypeGameState   = "game_state"
    MsgTypePlayerUpdate = "player_update"
    MsgTypeGameOver    = "game_over"
    
    // 系统消息
    MsgTypeError       = "error"
    MsgTypeSuccess     = "success"
)
```

### 消息结构规范
```go
// 基础消息结构
type Message struct {
    Type      string      `json:"type"`
    Data      interface{} `json:"data"`
    Timestamp int64       `json:"timestamp"`
    MessageID string      `json:"message_id,omitempty"`
    PlayerID  string      `json:"player_id,omitempty"`
}

// 连接消息
type JoinData struct {
    PlayerName string `json:"player_name"`
    Version    string `json:"version"`
}

type JoinResponse struct {
    Success  bool   `json:"success"`
    PlayerID string `json:"player_id,omitempty"`
    Message  string `json:"message,omitempty"`
}

// 房间操作消息
type CreateRoomData struct {
    RoomName   string `json:"room_name"`
    MaxPlayers int    `json:"max_players"`
    Password   string `json:"password,omitempty"`
}

type JoinRoomData struct {
    RoomID   string `json:"room_id"`
    Password string `json:"password,omitempty"`
}

type RoomListResponse struct {
    Rooms []RoomInfo `json:"rooms"`
    Total int        `json:"total"`
}

type RoomInfo struct {
    ID          string `json:"id"`
    Name        string `json:"name"`
    PlayerCount int    `json:"player_count"`
    MaxPlayers  int    `json:"max_players"`
    State       string `json:"state"`
    HasPassword bool   `json:"has_password"`
}

// 游戏消息
type PlayerInputData struct {
    Direction Direction `json:"direction"`
    Timestamp int64     `json:"timestamp"`
}

type Direction struct {
    X int `json:"x"`
    Y int `json:"y"`
}

type GameStateData struct {
    RoomID    string                 `json:"room_id"`
    State     string                 `json:"state"`
    Players   map[string]PlayerState `json:"players"`
    Foods     []FoodState           `json:"foods"`
    Timestamp int64                 `json:"timestamp"`
}

type PlayerState struct {
    ID       string      `json:"id"`
    Name     string      `json:"name"`
    Score    int         `json:"score"`
    IsAlive  bool        `json:"is_alive"`
    Snake    SnakeState  `json:"snake"`
}

type SnakeState struct {
    Head      Position    `json:"head"`
    Body      []Position  `json:"body"`
    Direction Direction   `json:"direction"`
    Length    int         `json:"length"`
}

type FoodState struct {
    Position Position `json:"position"`
    Value    int      `json:"value"`
    Type     string   `json:"type"`
}

type Position struct {
    X int `json:"x"`
    Y int `json:"y"`
}

// 游戏结束消息
type GameOverData struct {
    RoomID   string            `json:"room_id"`
    Winner   string            `json:"winner,omitempty"`
    Scores   map[string]int    `json:"scores"`
    Duration int64             `json:"duration"`
    Reason   string            `json:"reason"`
}

// 错误消息
type ErrorData struct {
    Code    int    `json:"code"`
    Message string `json:"message"`
    Details string `json:"details,omitempty"`
}
```

### 通信流程规范
```go
// 连接建立流程
// Client -> Server: {"type": "join", "data": {"player_name": "Player1", "version": "1.0"}}
// Server -> Client: {"type": "join", "data": {"success": true, "player_id": "uuid"}}

// 创建房间流程
// Client -> Server: {"type": "create_room", "data": {"room_name": "Room1", "max_players": 4}}
// Server -> Client: {"type": "success", "data": {"room_id": "uuid"}}
// Server -> All: {"type": "room_update", "data": {...}}

// 游戏状态同步流程
// Client -> Server: {"type": "player_input", "data": {"direction": {"x": 1, "y": 0}}}
// Server -> Room: {"type": "game_state", "data": {...}}

// 错误处理流程
// Server -> Client: {"type": "error", "data": {"code": 400, "message": "Room is full"}}
```

## 核心数据模型

### 玩家模型
```go
type Player struct {
    ID         string `json:"id"`
    Name       string `json:"name"`
    Score      int    `json:"score"`
    IsAlive    bool   `json:"is_alive"`
    RoomID     string `json:"room_id"`
    Connection *websocket.Conn `json:"-"`
}

func NewPlayer(id, name string, conn *websocket.Conn) *Player
func (p *Player) SendMessage(msg *Message) error
func (p *Player) IsConnected() bool
```

### 房间模型
```go
type RoomState string

const (
    RoomStateWaiting  RoomState = "waiting"
    RoomStatePlaying  RoomState = "playing"
    RoomStateFinished RoomState = "finished"
)

type Room struct {
    ID         string             `json:"id"`
    Name       string             `json:"name"`
    State      RoomState          `json:"state"`
    Players    map[string]*Player `json:"players"`
    MaxPlayers int                `json:"max_players"`
    OwnerID    string             `json:"owner_id"`
}

func NewRoom(id, name string, maxPlayers int) *Room
func (r *Room) AddPlayer(player *Player) error
func (r *Room) RemovePlayer(playerID string) error
func (r *Room) StartGame() error
```

## 服务接口

### 房间服务
```go
type RoomService interface {
    CreateRoom(name string, maxPlayers int, owner *Player) (*Room, error)
    JoinRoom(roomID string, player *Player) error
    LeaveRoom(roomID string, playerID string) error
    GetRoom(roomID string) (*Room, error)
    ListRooms() []*Room
}
```

### 玩家服务
```go
type PlayerService interface {
    RegisterPlayer(player *Player) error
    UnregisterPlayer(playerID string) error
    GetPlayer(playerID string) (*Player, error)
    GetPlayerStats(playerID string) (*PlayerStats, error)
    UpdatePlayerStats(playerID string, gameRecord *GameRecord) error
}
```

### 游戏服务
```go
type GameService interface {
    SaveGameRecord(record *GameRecord) error
    GetPlayerGameHistory(playerID string, limit int) ([]*GameRecord, error)
    GetRoomGameHistory(roomID string) ([]*GameRecord, error)
    GetLeaderboard(limit int) ([]*PlayerStats, error)
}
```

### 数据库服务
```go
type DatabaseService interface {
    // 玩家数据操作
    CreatePlayer(player *PlayerStats) error
    GetPlayerByID(id string) (*PlayerStats, error)
    UpdatePlayerStats(id string, stats *PlayerStats) error
    
    // 游戏记录操作
    SaveGameRecord(record *GameRecord) error
    GetGameRecordsByPlayer(playerID string, limit int) ([]*GameRecord, error)
    GetGameRecordsByRoom(roomID string) ([]*GameRecord, error)
    
    // 房间历史操作
    SaveRoomHistory(room *RoomHistory) error
    GetRoomHistory(limit int) ([]*RoomHistory, error)
    
    // 统计查询
    GetTopPlayers(limit int) ([]*PlayerStats, error)
    GetPlayerRanking(playerID string) (int, error)
}

type RoomHistory struct {
    ID            string    `json:"id" db:"id"`
    Name          string    `json:"name" db:"name"`
    MaxPlayers    int       `json:"max_players" db:"max_players"`
    ActualPlayers int       `json:"actual_players" db:"actual_players"`
    WinnerID      string    `json:"winner_id" db:"winner_id"`
    GameDuration  int       `json:"game_duration" db:"game_duration"`
    CreatedAt     time.Time `json:"created_at" db:"created_at"`
    FinishedAt    time.Time `json:"finished_at" db:"finished_at"`
}
```

### WebSocket处理器
```go
type WebSocketHandler interface {
    HandleConnection(conn *websocket.Conn)
    HandleMessage(player *Player, msg *Message)
    BroadcastToRoom(roomID string, msg *Message)
    BroadcastToAll(msg *Message)
    GetConnectedPlayers() []*Player
}
```

## 客户端接口规范

### NetworkManager.gd 接口
```gdscript
class_name NetworkManager
extends Node

signal connected_to_server
signal disconnected_from_server
signal room_joined(room_id: String)
signal game_state_updated(game_state: Dictionary)

enum ConnectionState { DISCONNECTED, CONNECTING, CONNECTED }

var connection_state: ConnectionState = ConnectionState.DISCONNECTED
var player_id: String = ""
var current_room_id: String = ""

func connect_to_server(url: String, player_name: String) -> void
func disconnect_from_server() -> void
func create_room(room_name: String, max_players: int) -> void
func join_room(room_id: String) -> void
func send_player_input(direction: Vector2) -> void
func is_connected() -> bool
```

## 代码生成要求

### 必须实现的核心功能
- [ ] 服务器：WebSocket连接管理、房间系统、消息路由
- [ ] 客户端：网络连接、消息处理、状态同步
- [ ] 通信协议：JSON消息格式、类型定义

### 质量标准
- [ ] 并发安全：线程安全的数据结构
- [ ] 错误处理：网络异常和状态恢复
- [ ] 性能优化：连接池和消息批处理