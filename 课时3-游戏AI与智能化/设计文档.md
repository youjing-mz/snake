# 课时3 设计文档 - 游戏AI系统

## 文档目的
定义AI系统的架构、决策接口和算法规范。

## AI系统架构

### AIPlayer.gd 主控制器
```gdscript
class_name AIPlayer
extends Node2D

signal ai_decision_made(direction: Vector2, reasoning: String)
signal ai_died(survival_time: float, score: int)

enum Difficulty { EASY, NORMAL, HARD, EXPERT }

const DIFFICULTY_CONFIGS: Dictionary = {
    Difficulty.EASY: {
        "reaction_delay": 0.5,
        "error_rate": 0.2,
        "look_ahead_steps": 1
    },
    Difficulty.NORMAL: {
        "reaction_delay": 0.2,
        "error_rate": 0.1,
        "look_ahead_steps": 3
    },
    Difficulty.HARD: {
        "reaction_delay": 0.1,
        "error_rate": 0.05,
        "look_ahead_steps": 5
    }
}

var ai_snake: Snake
var ai_brain: AIBrain
var difficulty: Difficulty = Difficulty.NORMAL
var reaction_delay: float = 0.2
var error_rate: float = 0.1

func make_ai_decision() -> void
func set_difficulty(new_difficulty: Difficulty) -> void
func get_ai_stats() -> Dictionary
```

### AIBrain.gd 决策核心
```gdscript
class_name AIBrain
extends Node

const DECISION_WEIGHTS: Dictionary = {
    "safety": 1.0,
    "food_distance": 0.6,
    "space_available": 0.4,
    "future_safety": 0.8
}

var pathfinder: PathFinder
var risk_analyzer: RiskAnalyzer
var space_analyzer: SpaceAnalyzer
var risk_tolerance: float = 0.5
var food_priority: float = 0.6
var look_ahead_steps: int = 3

func think(game_state: Dictionary) -> Vector2
func evaluate_direction(direction: Vector2, game_state: Dictionary) -> Dictionary
func get_possible_directions(current_direction: Vector2) -> Array[Vector2]
func set_risk_tolerance(tolerance: float) -> void
func set_food_priority(priority: float) -> void
```

### PathFinder.gd A*寻路算法
```gdscript
class_name PathFinder
extends Node

class AStarNode:
    var position: Vector2
    var g_cost: float = 0.0
    var h_cost: float = 0.0
    var f_cost: float = 0.0
    var parent: AStarNode = null
    
    func _init(pos: Vector2)
    func calculate_f_cost()

func find_path(start: Vector2, goal: Vector2, game_state: Dictionary) -> Array[Vector2]
func calculate_heuristic(from: Vector2, to: Vector2) -> float
func get_neighbors(position: Vector2, game_state: Dictionary) -> Array[Vector2]
func find_safe_direction(from: Vector2, game_state: Dictionary) -> Vector2
```

### RiskAnalyzer.gd 风险评估
```gdscript
class_name RiskAnalyzer
extends Node

var risk_tolerance: float = 0.5

func is_position_safe(position: Vector2, game_state: Dictionary) -> bool
func calculate_safety_score(position: Vector2, game_state: Dictionary) -> float
func calculate_border_safety(position: Vector2, game_state: Dictionary) -> float
func calculate_body_safety(position: Vector2, game_state: Dictionary) -> float
func count_escape_routes(position: Vector2, game_state: Dictionary) -> int
func detect_dead_end(position: Vector2, game_state: Dictionary, max_depth: int = 10) -> bool
func predict_future_risk(position: Vector2, direction: Vector2, game_state: Dictionary, steps: int = 3) -> float
```

### SpaceAnalyzer.gd 空间分析
```gdscript
class_name SpaceAnalyzer
extends Node

func calculate_space_score(position: Vector2, game_state: Dictionary) -> float
func calculate_available_space(start_position: Vector2, game_state: Dictionary) -> int
func analyze_space_distribution(game_state: Dictionary) -> Dictionary
func find_largest_connected_space(game_state: Dictionary) -> int
func is_position_accessible(position: Vector2, game_state: Dictionary) -> bool
```

## AI决策算法规范

### 决策流程
```
1. 获取可能移动方向（排除反向）
2. 对每个方向进行评估：
   - 安全性评分
   - 食物距离评分
   - 可用空间评分
   - 未来安全性评分
3. 根据权重计算总分
4. 选择最高分方向
5. 应用难度调节（错误率、延迟）
```

### A*寻路算法
```
1. 初始化开放列表和关闭列表
2. 将起点加入开放列表
3. 循环直到找到路径或开放列表为空：
   - 选择F值最小的节点
   - 检查是否到达目标
   - 探索相邻节点
   - 更新路径成本
4. 重构路径
```

### 风险评估算法
```
安全评分 = 边界安全性 × 蛇身安全性 × 陷阱安全性

边界安全性 = min(1.0, 最近边界距离 / 3.0)
蛇身安全性 = min(1.0, 最近蛇身距离 / 2.0)
陷阱安全性 = 基于逃生路线数量的评分
```

## 数据结构定义

### 游戏状态数据
```gdscript
# AI决策所需的游戏状态信息
{
    "snake_head": Vector2,
    "snake_body": Array[Vector2],
    "food_position": Vector2,
    "grid_width": int,
    "grid_height": int,
    "current_direction": Vector2
}
```

### 方向评估结果
```gdscript
# 每个方向的评估结果
{
    "direction": Vector2,
    "safety_score": float,
    "food_score": float,
    "space_score": float,
    "future_safety_score": float,
    "total_score": float
}
```

## AI可视化接口

### AIDebugVisualizer.gd 调试工具
```gdscript
class_name AIDebugVisualizer
extends Node2D

var show_debug: bool = false
var ai_player: AIPlayer

func set_ai_player(player: AIPlayer) -> void
func toggle_debug_visualization() -> void
func draw_decision_path(direction: Vector2) -> void
func show_decision_reasoning(reasoning: String) -> void
func clear_debug_visuals() -> void
```

## 代码生成要求

### 必须实现的核心功能
- [ ] AIPlayer：主控制器和难度系统
- [ ] AIBrain：决策核心和评估系统
- [ ] PathFinder：A*寻路算法
- [ ] RiskAnalyzer：安全性和风险评估
- [ ] SpaceAnalyzer：空间分析算法
- [ ] AIDebugVisualizer：调试可视化

### 算法性能要求
- [ ] A*搜索深度限制（防止无限循环）
- [ ] 决策频率控制（基于难度）
- [ ] 内存管理（及时清理临时数据）

### 质量标准
- [ ] 类型安全：明确的接口定义
- [ ] 算法正确性：经过测试验证
- [ ] 性能优化：合理的计算复杂度
- [ ] 可调试性：完整的可视化支持